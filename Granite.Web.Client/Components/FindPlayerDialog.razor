@using Fluxor
@using Granite.Common.Dto
@using Granite.Web.Client.Services.Api.Players
@using MudBlazor
@inject IPlayersApiClient PlayersApiClient


<MudDialog>
    <DialogContent>
        <MudAutocomplete T="PlayerNameIdDTO" @bind-Value="_selectedPlayer" SearchFunc="@SearchPlayersAsync"
            ToStringFunc="@(p => p?.Name ?? string.Empty)" Label="@SearchPlaceholder" Variant="Variant.Outlined"
            FullWidth="true" ResetValueOnEmptyText="false" CoerceText="true" CoerceValue="true" SelectValueOnTab="true"
            AdornmentIcon="@Icons.Material.Filled.Search" AdornmentColor="Color.Primary" @onblur="@OnInputBlurAsync"
            HelperText="@_validationError" HelperTextOnFocus="false" Error="@(!string.IsNullOrEmpty(_validationError))"
            Class="mb-3" Disabled="@_isLoading">
            <ItemTemplate Context="player">
                @if (player.Id == "__SERVER_SEARCH__")
                {
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.Cloud" Color="Color.Info" />
                        <MudText Typo="Typo.body2" Color="Color.Info" Style="font-style: italic;">
                            Search for "@player.Name" on VintageStory servers...
                        </MudText>
                    </MudStack>
                }
                else
                {
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudAvatar Size="Size.Small" Color="Color.Primary">
                            @(player.Name?.FirstOrDefault().ToString().ToUpper() ?? "?")
                        </MudAvatar>
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.body2">@player.Name</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@player.Id</MudText>
                        </MudStack>
                    </MudStack>
                }
            </ItemTemplate>
            <NoItemsTemplate>
                <MudText Align="Align.Center" Class="px-4 py-3">No players found</MudText>
            </NoItemsTemplate>
        </MudAutocomplete>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Disabled="@_isLoading">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="ConfirmAsync"
            Disabled="@(_selectedPlayer == null || !string.IsNullOrEmpty(_validationError) || _isLoading)">
            @if (_isLoading)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                <MudText Class="ml-2">Searching...</MudText>
            }
            else if (_pendingServerSearch)
            {
                @:Search and Add
            }
            else
            {
                @SelectButtonText
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public string SelectButtonText { get; set; } = "Select";

    [Parameter]
    public string SearchPlaceholder { get; set; } = "Search by player name or UID...";

    [Parameter]
    public IEnumerable<PlayerDTO> InitialPlayers { get; set; } = Enumerable.Empty<PlayerDTO>();

    [Parameter]
    public Func<PlayerDTO, bool> OnFilterPlayer { get; set; } = null!;


    private PlayerNameIdDTO? _selectedPlayer = null;
    private string? _selectedPlayerUid = null;
    private string _validationError = string.Empty;
    private string _lastSearchText = string.Empty;
    private bool _pendingServerSearch = false;
    private bool _isLoading = false;

    private Task<IEnumerable<PlayerNameIdDTO>> SearchPlayersAsync(string searchText, CancellationToken
    cancellationToken)
    {
        // Track the current input text for validation on blur
        _lastSearchText = searchText;

        // Clear validation error and pending state when user is actively searching
        _validationError = string.Empty;
        _pendingServerSearch = false;

        if (string.IsNullOrWhiteSpace(searchText))
        {
            // Return initial filtered players when search is empty, converted to PlayerNameIdDTO
            return Task.FromResult(InitialPlayers.Where(OnFilterPlayer).Select(ConvertToPlayerNameIdDTO).AsEnumerable());
        }

        var query = searchText.Trim();

        // Search locally in InitialPlayers
        var localResults = InitialPlayers
            .Where(OnFilterPlayer)
            .Where(p => p.Name?.Contains(query, StringComparison.OrdinalIgnoreCase) == true ||
                       p.PlayerUID?.Contains(query, StringComparison.OrdinalIgnoreCase) == true)
            .Select(ConvertToPlayerNameIdDTO)
            .ToList();

        // If we have local results, return them
        if (localResults.Any())
        {
            return Task.FromResult(localResults.AsEnumerable());
        }

        // No local results - return a special sentinel item to trigger server search
        var result = new List<PlayerNameIdDTO>
        {
            new PlayerNameIdDTO
            {
                Id = "__SERVER_SEARCH__",
                Name = query
            }
        };
        return Task.FromResult(result.AsEnumerable());
    }

    private PlayerNameIdDTO ConvertToPlayerNameIdDTO(PlayerDTO dto)
    {
        return new PlayerNameIdDTO
        {
            Id = dto.PlayerUID ?? string.Empty,
            Name = dto.Name ?? string.Empty
        };
    }

    private async Task ValidatePlayerInputAsync(string? input)
    {
        _validationError = string.Empty;
        _selectedPlayerUid = null;

        if (string.IsNullOrWhiteSpace(input))
        {
            return;
        }

        var query = input.Trim().ToLower();

        // Search in InitialPlayers first (by name or UID)
        var foundPlayer = InitialPlayers
        .Where(OnFilterPlayer)
        .FirstOrDefault(p => p.Name?.Equals(query, StringComparison.OrdinalIgnoreCase) == true ||
        p.PlayerUID?.Equals(query, StringComparison.OrdinalIgnoreCase) == true);

        if (foundPlayer != null)
        {
            _selectedPlayerUid = foundPlayer.PlayerUID;
            return;
        }

        // Attempt server-side search if not found locally
        try
        {
            var serverResults = await FindPlayerByNameAsync(input);
            var foundServerPlayer = serverResults
            .FirstOrDefault(p => p.Name?.Equals(query, StringComparison.OrdinalIgnoreCase) == true);

            if (foundServerPlayer != null)
            {
                _selectedPlayerUid = foundServerPlayer.Id;
                return;
            }
        }
        catch (Exception)
        {
            // Server search failed
        }

        // No matching player found
        _validationError = $"No player found matching '{input}'";
    }

    private void Cancel()
    {
        MudDialog.Close(DialogResult.Cancel());
    }

    private async Task<IEnumerable<PlayerNameIdDTO>> FindPlayerByNameAsync(string playerName)
    {
        try
        {
            var response = await PlayersApiClient.FindPlayerByNameAsync(playerName);
            if (response.Data != null)
            {
                return new[] { response.Data };
            }
            return Enumerable.Empty<PlayerNameIdDTO>();
        }
        catch
        {
            return Enumerable.Empty<PlayerNameIdDTO>();
        }
    }

    private async Task ConfirmAsync()
    {
        if (_selectedPlayer == null)
        {
            _validationError = "Please select a player";
            return;
        }

        // Check if user selected the server search option
        if (_selectedPlayer.Id == "__SERVER_SEARCH__")
        {
            await PerformServerSearchAsync(_selectedPlayer.Name);
            return;
        }

        // Normal selection - close with the player UID
        _selectedPlayerUid = _selectedPlayer.Id;
        if (string.IsNullOrEmpty(_selectedPlayerUid))
        {
            _validationError = "Invalid player selection";
            return;
        }

        MudDialog.Close(DialogResult.Ok(_selectedPlayerUid));
    }

    private async Task PerformServerSearchAsync(string playerName)
    {
        _isLoading = true;
        _validationError = string.Empty;
        StateHasChanged();

        try
        {
            var response = await PlayersApiClient.FindPlayerByNameAsync(playerName);
            var player = response.Data;

            if (player == null || string.IsNullOrEmpty(player.Id))
            {
                _validationError = $"No player found with name '{playerName}' on VintageStory servers";
                return;
            }

            // Success - close dialog with the found player UID
            MudDialog.Close(DialogResult.Ok(player.Id));
        }
        catch (Exception ex)
        {
            _validationError = $"Error searching server: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private Task OnInputBlurAsync()
    {
        // When user leaves the input field, validate the current text if no player selected
        if (string.IsNullOrEmpty(_selectedPlayerUid) && !string.IsNullOrEmpty(_lastSearchText))
        {
            return ValidatePlayerInputAsync(_lastSearchText);
        }
        return Task.CompletedTask;
    }
}