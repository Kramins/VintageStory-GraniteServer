@page "/world-map"
@page "/{serverId}/world-map"
@attribute [Authorize]
@using Granite.Common.Dto
@using Granite.Web.Client.Services
@using Microsoft.JSInterop
@inject WorldMapService MapService
@inject IJSRuntime JSRuntime
@inject ILogger<WorldMap> Logger
@implements IAsyncDisposable

<PageTitle>World Map - Granite Server Manager</PageTitle>

<MudContainer MaxWidth="MaxWidth.False" Class="pa-4">
    <MudText Typo="Typo.h3" GutterBottom="true">World Map</MudText>

    @if (_isLoading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
        <MudText>Loading map data...</MudText>
    }
    else if (_error != null)
    {
        <MudAlert Severity="Severity.Error" Class="my-4">@_error</MudAlert>
    }
    else if (_bounds != null)
    {
        <MudPaper Class="pa-4 mb-4">
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.body2"><strong>X Range:</strong> @_bounds.MinChunkX to @_bounds.MaxChunkX</MudText>
                    <MudText Typo="Typo.body2"><strong>Z Range:</strong> @_bounds.MinChunkZ to @_bounds.MaxChunkZ</MudText>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.body2"><strong>Total Chunks:</strong> @_bounds.TotalChunks</MudText>
                    <MudText Typo="Typo.body2" Class="text-muted">Each tile is 32x32 blocks</MudText>
                </MudItem>
            </MudGrid>
        </MudPaper>

        <MudPaper Class="pa-0" Style="height: 600px; position: relative;">
            <div id="map" style="width: 100%; height: 100%;"></div>
        </MudPaper>

        @if (_selectedTileMetadata != null)
        {
            <MudPaper Class="pa-4 mt-4">
                <MudText Typo="Typo.h6">Selected Tile Information</MudText>
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudText Typo="Typo.body2"><strong>Chunk X:</strong> @_selectedTileMetadata.ChunkX</MudText>
                        <MudText Typo="Typo.body2"><strong>Chunk Z:</strong> @_selectedTileMetadata.ChunkZ</MudText>
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudText Typo="Typo.body2"><strong>Size:</strong> @_selectedTileMetadata.Width x
                            @_selectedTileMetadata.Height</MudText>
                        <MudText Typo="Typo.body2"><strong>Extracted:</strong> @_selectedTileMetadata.ExtractedAt.ToString("g")
                        </MudText>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        }
    }
</MudContainer>

@code {
    [Parameter]
    public string? ServerId { get; set; }

    private WorldMapBoundsDTO? _bounds;
    private MapTileMetadataDTO? _selectedTileMetadata = null;
    private bool _isLoading = true;
    private string? _error;
    private Guid _serverGuid;
    private bool _mapInitialized = false;

    protected override async Task OnInitializedAsync()
    {
        // For now, use a test server ID if none provided
        // TODO: Get from route or state management
        if (!string.IsNullOrEmpty(ServerId) && Guid.TryParse(ServerId, out var guid))
        {
            _serverGuid = guid;
        }
        else
        {
            _error = "No server ID provided. Please select a server first.";
            _isLoading = false;
            return;
        }

        await LoadMapData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!_mapInitialized && _bounds != null && _error == null)
        {
            try
            {
                var baseTileUrl = MapService.GetBaseTileUrl(_serverGuid);
                var authToken = await MapService.GetTileServerBearerTokenAsync();


                // Calculate center from bounds
                var centerX = (_bounds.MinChunkX + _bounds.MaxChunkX) / 2.0;
                var centerZ = (_bounds.MinChunkZ + _bounds.MaxChunkZ) / 2.0;

                await JSRuntime.InvokeVoidAsync("mapInterop.initializeMap",
                "map",
                baseTileUrl,
                new[] { centerX, centerZ } // center [lon, lat]
                , authToken
                );

                _mapInitialized = true;
                Logger.LogInformation("Map initialized for server {ServerId} with center ({CenterX}, {CenterZ})",
                _serverGuid, centerX, centerZ);

                MapService.SubscribeToTileUpdates(_serverGuid, async (metadata) =>
                {
                    Logger.LogInformation("Received map tile update for server {ServerId} at tile ({TileX}, {TileZ})",
                    _serverGuid, metadata.Data.TileX, metadata.Data.TileZ);
                    await JSRuntime.InvokeVoidAsync("mapInterop.invalidateTile", metadata.Data.TileX, metadata.Data.TileZ);
                } );
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error initializing map");
                _error = $"Failed to initialize map: {ex.Message}";
                StateHasChanged();
            }
        }
    }

    private async Task LoadMapData()
    {
        _isLoading = true;
        _error = null;

        try
        {
            _bounds = await MapService.GetWorldBoundsAsync(_serverGuid);

            if (_bounds == null)
            {
                _error = "No map data available for this server.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading map data");
            _error = $"Failed to load map data: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("mapInterop.dispose");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error disposing map");
        }
    }
}