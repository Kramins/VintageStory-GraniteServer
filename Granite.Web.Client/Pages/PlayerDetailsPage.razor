@page "/{serverId}/players/{playerUid}"
@using Fluxor
@using Fluxor.Blazor.Web.Components
@using Granite.Web.Client.Store.Features.Players
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inherits FluxorComponent

@inject IState<PlayersState> PlayersState
@inject IDispatcher Dispatcher
@inject NavigationManager Navigation
@inject IServerPlayersApiClient PlayersApiClient
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Player Details - @(PlayersState.Value.SelectedPlayerDetails?.Name ?? "Loading...")</PageTitle>

@if (string.IsNullOrEmpty(ServerId) || string.IsNullOrEmpty(PlayerUid))
{
    <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
        <MudPaper Class="pa-8 d-flex flex-column align-center justify-center" Style="min-height: 400px;" Elevation="0">
            <MudText Typo="Typo.h5" Color="Color.Secondary" Class="mb-2">
                Invalid player or server ID
            </MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => Navigation.NavigateTo($"/{ServerId}/players"))">
                Back to Players
            </MudButton>
        </MudPaper>
    </MudContainer>
}
else if (PlayersState.Value.IsLoading && PlayersState.Value.SelectedPlayerDetails == null)
{
    <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
        <MudStack AlignItems="AlignItems.Center" Spacing="2" Class="mt-8">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
            <MudText Typo="Typo.h6">Loading player details...</MudText>
        </MudStack>
    </MudContainer>
}
else if (!string.IsNullOrEmpty(PlayersState.Value.ErrorMessage))
{
    <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
        <MudAlert Severity="Severity.Error" Class="mb-4">
            @PlayersState.Value.ErrorMessage
        </MudAlert>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => Navigation.NavigateTo($"/{ServerId}/players"))">
            Back to Players
        </MudButton>
    </MudContainer>
}
else if (PlayersState.Value.SelectedPlayerDetails != null)
{
    var player = PlayersState.Value.SelectedPlayerDetails;
    
    <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
        @* Player Header *@
        <MudStack Spacing="1" Class="mb-4">
            <MudText Typo="Typo.h4">@player.Name</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                ID: @player.PlayerUID
            </MudText>
        </MudStack>

        @* Action Buttons *@
        <MudPaper Elevation="0" Class="pa-4 mb-4" Style="background-color: var(--mud-palette-background-grey); border: 1px solid var(--mud-palette-divider);">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Wrap="Wrap.Wrap">
                <MudButton StartIcon="@Icons.Material.Filled.Refresh" 
                           OnClick="@HandleRefresh" 
                           Disabled="@PlayersState.Value.IsLoading"
                           Variant="Variant.Text">
                    Refresh
                </MudButton>
                <MudButton StartIcon="@Icons.Material.Filled.PowerSettingsNew" 
                           OnClick="@HandleKick" 
                           Disabled="@PlayersState.Value.IsLoading"
                           Variant="Variant.Text">
                    Kick
                </MudButton>
                <MudButton StartIcon="@(player.IsBanned ? Icons.Material.Filled.LockOpen : Icons.Material.Filled.Block)" 
                           OnClick="@HandleToggleBan" 
                           Disabled="@PlayersState.Value.IsLoading"
                           Variant="Variant.Text">
                    @(player.IsBanned ? "Unban" : "Ban")
                </MudButton>
                <MudButton StartIcon="@(player.IsWhitelisted ? Icons.Material.Filled.PlaylistRemove : Icons.Material.Filled.PlaylistAddCheck)" 
                           OnClick="@HandleToggleWhitelist" 
                           Disabled="@PlayersState.Value.IsLoading"
                           Variant="Variant.Text">
                    @(player.IsWhitelisted ? "Remove WL" : "Whitelist")
                </MudButton>
                <MudSpacer />
                <MudText Typo="Typo.body2" Color="Color.Secondary">Actions</MudText>
            </MudStack>
        </MudPaper>

        @* Tabs *@
        <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4">
            <MudTabPanel Text="Overview" Icon="@Icons.Material.Filled.Dashboard">
                <PlayerOverviewTab Player="@player" />
            </MudTabPanel>

            <MudTabPanel Text="Inventory" Icon="@Icons.Material.Filled.Inventory">
                <PlayerInventoryTab Player="@player" />
            </MudTabPanel>

            <MudTabPanel Text="Permissions" Icon="@Icons.Material.Filled.Security">
                <PlayerPermissionsTab Player="@player" />
            </MudTabPanel>

            <MudTabPanel Text="Sessions" Icon="@Icons.Material.Filled.History">
                <PlayerSessionsTab Player="@player" />
            </MudTabPanel>
        </MudTabs>
    </MudContainer>
}

@code {
    [Parameter]
    public string? ServerId { get; set; }

    [Parameter]
    public string? PlayerUid { get; set; }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        LoadPlayerDetails();
    }

    protected override void OnParametersSet()
    {
        LoadPlayerDetails();
    }

    private void LoadPlayerDetails()
    {
        if (!string.IsNullOrEmpty(ServerId) && !string.IsNullOrEmpty(PlayerUid))
        {
            Dispatcher.Dispatch(new FetchPlayerDetailsAction(ServerId, PlayerUid));
        }
    }

    private void HandleRefresh()
    {
        LoadPlayerDetails();
    }

    private async Task HandleKick()
    {
        var player = PlayersState.Value.SelectedPlayerDetails;
        if (player == null) return;

        var parameters = new DialogParameters<KickPlayerDialog>
        {
            { x => x.PlayerName, player.Name ?? "Unknown" }
        };

        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<KickPlayerDialog>("Kick Player", parameters, options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled && result.Data is string reason)
        {
            try
            {
                await PlayersApiClient.KickPlayerAsync(ServerId!, PlayerUid!, reason);
                Snackbar.Add("Player kicked successfully", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Failed to kick player: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task HandleToggleBan()
    {
        var player = PlayersState.Value.SelectedPlayerDetails;
        if (player == null) return;

        if (player.IsBanned)
        {
            var parameters = new DialogParameters<UnbanPlayerDialog>
            {
                { x => x.PlayerName, player.Name ?? "Unknown" }
            };

            var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
            var dialog = await DialogService.ShowAsync<UnbanPlayerDialog>("Unban Player", parameters, options);
            var result = await dialog.Result;

            if (result is not null && !result.Canceled)
            {
                Snackbar.Add("Unban functionality not yet implemented", Severity.Info);
            }
        }
        else
        {
            var parameters = new DialogParameters<BanPlayerDialog>
            {
                { x => x.PlayerName, player.Name ?? "Unknown" }
            };

            var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
            var dialog = await DialogService.ShowAsync<BanPlayerDialog>("Ban Player", parameters, options);
            var result = await dialog.Result;

            if (result is not null && !result.Canceled && result.Data is string reason)
            {
                try
                {
                    await PlayersApiClient.BanPlayerAsync(ServerId!, PlayerUid!, reason);
                    Snackbar.Add("Player banned successfully", Severity.Success);
                    LoadPlayerDetails();
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"Failed to ban player: {ex.Message}", Severity.Error);
                }
            }
        }
    }

    private async Task HandleToggleWhitelist()
    {
        var player = PlayersState.Value.SelectedPlayerDetails;
        if (player == null) return;

        if (player.IsWhitelisted)
        {
            var parameters = new DialogParameters<RemoveWhitelistDialog>
            {
                { x => x.PlayerName, player.Name ?? "Unknown" }
            };

            var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
            var dialog = await DialogService.ShowAsync<RemoveWhitelistDialog>("Remove from Whitelist", parameters, options);
            var result = await dialog.Result;

            if (result is not null && !result.Canceled)
            {
                try
                {
                    await PlayersApiClient.RemoveFromWhitelistAsync(ServerId!, PlayerUid!);
                    Snackbar.Add("Player removed from whitelist", Severity.Success);
                    LoadPlayerDetails();
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"Failed to remove from whitelist: {ex.Message}", Severity.Error);
                }
            }
        }
        else
        {
            var parameters = new DialogParameters<WhitelistPlayerDialog>
            {
                { x => x.PlayerName, player.Name ?? "Unknown" }
            };

            var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
            var dialog = await DialogService.ShowAsync<WhitelistPlayerDialog>("Whitelist Player", parameters, options);
            var result = await dialog.Result;

            if (result is not null && !result.Canceled)
            {
                try
                {
                    await PlayersApiClient.WhitelistPlayerAsync(ServerId!, PlayerUid!);
                    Snackbar.Add("Player whitelisted successfully", Severity.Success);
                    LoadPlayerDetails();
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"Failed to whitelist player: {ex.Message}", Severity.Error);
                }
            }
        }
    }
}
