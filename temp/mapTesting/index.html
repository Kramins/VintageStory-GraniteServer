<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Vintage Story World Map</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@9.2.4/ol.css" />
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #111;
    }

    #map {
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <script src="https://cdn.jsdelivr.net/npm/ol@9.2.4/dist/ol.js"></script>
  <script>
    const TILE_SIZE = 256;
    const CHUNKS_PER_GROUP = 8;
    const SERVER_ID = 'd3cd8403-ebd3-4cba-a88b-7cc63eb2c0c6';
    const BASE_URL = 'http://localhost:5000';

    const SPAWN_CHUNK_X = 15998;
    const SPAWN_CHUNK_Z = 16000;
    const SPAWN_GROUP_X = Math.floor(SPAWN_CHUNK_X / CHUNKS_PER_GROUP);
    const SPAWN_GROUP_Z = Math.floor(SPAWN_CHUNK_Z / CHUNKS_PER_GROUP);

    console.log('=== Vintage Story Map Initializing ===');
    console.log(`Spawn: Chunk(${SPAWN_CHUNK_X}, ${SPAWN_CHUNK_Z}) = Group(${SPAWN_GROUP_X}, ${SPAWN_GROUP_Z})`);

    const extent = [-1000000, -1000000, 1000000, 1000000];

    const projection = new ol.proj.Projection({
      code: 'VS-PIXEL',
      units: 'pixels',
      extent: extent
    });

    const tileGrid = new ol.tilegrid.TileGrid({
      origin: [extent[0], extent[3]],
      tileSize: TILE_SIZE,
      resolutions: [1]
    });

    const tileSource = new ol.source.TileImage({
      projection: projection,
      tileGrid: tileGrid,
      wrapX: false,
      crossOrigin: 'anonymous',
      tileUrlFunction: function (tileCoord) {
        if (!tileCoord) return null;

        const tileX = tileCoord[1];
        const tileY = tileCoord[2];

        const groupX = tileX + Math.floor(extent[0] / TILE_SIZE);
        const groupZ = tileY - Math.floor(extent[3] / TILE_SIZE);

        const url = `${BASE_URL}/api/worldmap/${SERVER_ID}/tiles/grouped/${groupX}/${groupZ}`;

        return url;
      },
      tileLoadFunction: function (imageTile, src) {
        const img = imageTile.getImage();
        img.crossOrigin = 'anonymous';

        const match = src.match(/grouped\/(-?\d+)\/(-?\d+)/);
        const coords = match ? `(${match[1]}, ${match[2]})` : '?';

        img.onload = () => console.log(`✓ Tile loaded: ${coords}`);
        img.onerror = () => console.log(`✗ Tile failed: ${coords}`);

        img.src = src;
      }
    });

    const map = new ol.Map({
      target: 'map',
      layers: [new ol.layer.Tile({ source: tileSource })],
      view: new ol.View({
        projection: projection,
        center: [
          SPAWN_GROUP_X * TILE_SIZE,
          -SPAWN_GROUP_Z * TILE_SIZE
        ],
        resolution: 1,
        minResolution: 1,
        maxResolution: 1,
        constrainResolution: true,
        enableRotation: false
      })
    });

    map.on('moveend', () => {
      const center = map.getView().getCenter();
      const gx = Math.round(center[0] / TILE_SIZE);
      const gz = Math.round(-center[1] / TILE_SIZE);
      const cx = gx * CHUNKS_PER_GROUP;
      const cz = gz * CHUNKS_PER_GROUP;
      console.log(`View center: Group(${gx}, ${gz}) = Chunk(${cx}, ${cz})`);
    });

    map.on('click', (evt) => {
      const [px, py] = evt.coordinate;
      const gx = Math.floor(px / TILE_SIZE);
      const gz = Math.floor(-py / TILE_SIZE);
      const cx = gx * CHUNKS_PER_GROUP;
      const cz = gz * CHUNKS_PER_GROUP;
      console.log(`Clicked: Group(${gx}, ${gz}) = Chunk(${cx}, ${cz})`);
    });

    // Utility functions accessible from console
    window.vsMap = {
      map: map,
      goToGroup: (groupX, groupZ) => {
        map.getView().setCenter([groupX * TILE_SIZE, -groupZ * TILE_SIZE]);
        console.log(`Navigated to Group(${groupX}, ${groupZ})`);
      },
      goToChunk: (chunkX, chunkZ) => {
        const groupX = Math.floor(chunkX / CHUNKS_PER_GROUP);
        const groupZ = Math.floor(chunkZ / CHUNKS_PER_GROUP);
        map.getView().setCenter([groupX * TILE_SIZE, -groupZ * TILE_SIZE]);
        console.log(`Navigated to Chunk(${chunkX}, ${chunkZ}) = Group(${groupX}, ${groupZ})`);
      }
    };

    console.log('=== Map Ready ===');
    console.log('Use window.vsMap.goToGroup(x, z) or window.vsMap.goToChunk(x, z) to navigate');
  </script>
</body>

</html>